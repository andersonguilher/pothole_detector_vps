<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConservApp - Detecção Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-slate-100 min-h-screen font-sans">

    <nav class="bg-blue-900 text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-road text-yellow-400 text-2xl"></i>
                <span class="text-xl font-bold tracking-wide">ConservApp AI</span>
            </div>
            <div class="text-sm opacity-80">22ª Gerência de Conservação</div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto mt-10 p-4">

        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800">Detecção de Falhas no Pavimento</h1>
            <p class="text-slate-500 mt-2">Envie uma foto para análise automática via IA</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-2/3">
                <div class="bg-white rounded-xl shadow-md p-8 text-center transition-all duration-300 border-2 border-dashed border-slate-300 hover:border-blue-500"
                    id="drop-zone">

                    <input type="file" id="file-input-camera" class="hidden" accept="image/*" capture="environment">
                    <input type="file" id="file-input-gallery" class="hidden" accept="image/*">

                    <div id="upload-content">
                        <div
                            class="mb-4 text-blue-100 bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-white"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-700">Selecione a fonte da imagem</h3>
                        <p class="text-sm text-slate-400 mt-4">Suporta JPG, PNG</p>

                        <div class="mt-6 flex justify-center space-x-4">
                            <button id="btn-camera"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center shadow-lg">
                                <i class="fa-solid fa-camera mr-2"></i> Capturar Foto
                            </button>
                            <button id="btn-gallery"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center shadow-lg">
                                <i class="fa-solid fa-folder-open mr-2"></i> Enviar da Galeria
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="mt-4 text-blue-600 font-semibold">Analisando pavimento...</p>
                    </div>

                    <div id="image-view" class="hidden mt-4">
                        <h4 class="font-bold text-slate-700 mb-2 flex items-center justify-center"><i
                                class="fa-solid fa-eye mr-2"></i> Análise Visual</h4>
                        <img id="result-image" src="" alt="Resultado"
                            class="max-h-[500px] w-full object-contain rounded-lg shadow-md border border-slate-300 mx-auto">

                        <div class="flex justify-center mt-4 text-sm space-x-4">
                            <span class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-green-500 border border-slate-600"></div>
                                <span>Dano Real</span>
                            </span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="lg:w-1/3">
                <div id="report-placeholder" class="hidden">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden animate-fade-in">
                        <div class="bg-blue-900 text-white px-6 py-3 flex justify-between items-center">
                            <span class="font-semibold"><i class="fa-solid fa-file-invoice mr-2"></i> Relatório
                                Técnico</span>
                            <span id="occurrences" class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">
                                0 Ocorrência(s)
                            </span>
                        </div>

                        <div class="p-4">
                            <table id="report-table" class="min-w-full divide-y divide-slate-200 text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th
                                            class="px-3 py-2 text-left font-medium text-slate-500 uppercase tracking-wider w-1/4">
                                            ID</th>
                                        <th
                                            class="px-3 py-2 text-right font-medium text-slate-500 uppercase tracking-wider w-1/4">
                                            DANO (m²)</th>
                                        <th
                                            class="px-3 py-2 text-right font-medium text-slate-500 uppercase tracking-wider w-1/2">
                                            CBUQ* (t)</th>
                                    </tr>
                                </thead>
                                <tbody id="report-body" class="bg-white divide-y divide-slate-200">
                                </tbody>
                                <tfoot class="font-bold text-slate-700 bg-slate-100 border-t-2 border-slate-300">
                                    <tr>
                                        <td class="px-3 py-2">TOTAL</td>
                                        <td id="total-dano" class="px-3 py-2 text-right">0.0000</td>
                                        <td id="total-cbuq" class="px-3 py-2 text-right">0.0000</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div class="mt-4 text-xs text-slate-500 space-y-1">
                                <p>* <strong>Massa Estimada:</strong> Baseada na Área de Dano. Considerando densidade
                                    2,4 t/m³ e espessura 5 cm.</p>
                            </div>

                            <div class="mt-6 flex justify-center space-x-4">
                                <button onclick="reset()"
                                    class="bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium transition flex items-center shadow-lg">
                                    <i class="fa-solid fa-redo-alt mr-2"></i> Nova Análise
                                </button>
                                <a id="download-btn" href="#" download="resultado_conservapp.jpg"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center shadow-lg">
                                    <i class="fa-solid fa-download mr-2"></i> Baixar Foto
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInputCamera = document.getElementById('file-input-camera');
        const fileInputGallery = document.getElementById('file-input-gallery');
        const btnCamera = document.getElementById('btn-camera');
        const btnGallery = document.getElementById('btn-gallery');

        const uploadContent = document.getElementById('upload-content');
        const loading = document.getElementById('loading');
        const imageView = document.getElementById('image-view');
        const resultImage = document.getElementById('result-image');
        const downloadBtn = document.getElementById('download-btn');

        // Elementos do Relatório
        const reportPlaceholder = document.getElementById('report-placeholder');
        const occurrencesSpan = document.getElementById('occurrences');
        const reportBody = document.getElementById('report-body');
        const totalDano = document.getElementById('total-dano');
        const totalCbuq = document.getElementById('total-cbuq');

        // Dispara os inputs
        btnCamera.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInputCamera.click();
        });

        btnGallery.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInputGallery.click();
        });

        // Handle file selection (Ouve os dois inputs)
        fileInputCamera.addEventListener('change', (e) => {
            if (e.target.files.length > 0) processFile(e.target.files[0]);
        });

        fileInputGallery.addEventListener('change', (e) => {
            if (e.target.files.length > 0) processFile(e.target.files[0]);
        });


        async function processFile(file) {
            // Esconde upload, mostra loading
            uploadContent.classList.add('hidden');
            loading.classList.remove('hidden');
            imageView.classList.add('hidden');
            reportPlaceholder.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Caminho absoluto que o Nginx está configurado para rotear
                const apiUrl = '/detector/detectar';

                // Requisição POST para o endpoint
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();

                    // --- 1. Exibir Imagem ---
                    const imageUrl = `data:image/jpeg;base64,${result.image_b64}`;
                    resultImage.src = imageUrl;
                    downloadBtn.href = imageUrl;

                    // --- 2. Preencher Relatório ---
                    reportBody.innerHTML = ''; // Limpa resultados anteriores

                    if (result.count === 0) {
                        // Colspan ajustado para 3 colunas
                        reportBody.innerHTML = `<tr><td colspan="3" class="px-3 py-2 text-center text-slate-500">Nenhuma falha detectada com confiança alta.</td></tr>`;
                    } else {
                        result.report_data.forEach(item => {
                            // Usando os novos campos 'dano_m2' e 'cbuq_t'
                            const row = `
                                <tr>
                                    <td class="px-3 py-2 font-bold">${item.id}</td>
                                    <td class="px-3 py-2 text-right">${item.dano_m2}</td>
                                    <td class="px-3 py-2 text-right">${item.cbuq_t}</td>
                                </tr>
                            `;
                            reportBody.insertAdjacentHTML('beforeend', row);
                        });
                    }

                    // Preencher totais e ocorrências
                    occurrencesSpan.textContent = `${result.count} Ocorrência(s)`;
                    // Usando os novos totais 'total_dano_m2' e 'total_cbuq_t'
                    totalDano.textContent = result.total_dano_m2;
                    totalCbuq.textContent = result.total_cbuq_t;

                    // Mostrar resultados
                    imageView.classList.remove('hidden');
                    reportPlaceholder.classList.remove('hidden');

                } else {
                    alert('Erro na análise. Tente novamente. (Código HTTP: ' + response.status + ')');
                }
            } catch (error) {
                console.error(error);
                alert('Erro de conexão com o servidor ou de processamento.');
            } finally {
                // Esconde loading
                loading.classList.add('hidden');
            }
        }

        function reset() {
            // Esconde resultados, mostra upload
            imageView.classList.add('hidden');
            reportPlaceholder.classList.add('hidden');
            uploadContent.classList.remove('hidden');

            // Limpa inputs
            fileInputCamera.value = '';
            fileInputGallery.value = '';

            // Reseta totais para zero visualmente
            occurrencesSpan.textContent = `0 Ocorrência(s)`;
            totalDano.textContent = '0.0000';
            totalCbuq.textContent = '0.0000';
            reportBody.innerHTML = ''; // Limpa o corpo da tabela
        }
    </script>
</body>

</html>