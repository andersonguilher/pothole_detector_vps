<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConservApp - Detecção Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .result-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen font-sans">

    <nav class="bg-blue-900 text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-road text-yellow-400 text-2xl"></i>
                <span class="text-xl font-bold tracking-wide">ConservApp AI</span>
            </div>
            <div class="text-sm opacity-80">22ª Gerência de Conservação</div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto mt-10 p-4">

        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800">Detecção de Falhas no Pavimento</h1>
            <p class="text-slate-500 mt-2">Envie uma foto para análise automática via IA</p>
        </div>

        <div id="upload-area">
            <div class="bg-white rounded-xl shadow-md p-8 text-center transition-all duration-300 border-2 border-dashed border-slate-300 hover:border-blue-500"
                id="drop-zone">

                <input type="file" id="file-input-camera" class="hidden" accept="image/*" capture="environment">
                <input type="file" id="file-input-gallery" class="hidden" accept="image/*" multiple>

                <div id="upload-content">
                    <div
                        class="mb-4 text-blue-100 bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-white"></i>
                    </div>
                    <h3 class="text-lg font-medium text-slate-700">Arraste ou clique para selecionar fotos</h3>
                    <p class="text-sm text-slate-400 mt-4">Suporta JPG, PNG. Pode selecionar **múltiplas fotos**.</p>

                    <div class="mt-6 flex justify-center space-x-4">
                        <button id="btn-camera"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center shadow-lg">
                            <i class="fa-solid fa-camera mr-2"></i> Capturar Foto
                        </button>
                        <button id="btn-gallery"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center shadow-lg">
                            <i class="fa-solid fa-folder-open mr-2"></i> Enviar da Galeria
                        </button>
                    </div>
                </div>

                <div id="loading" class="hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-4 text-blue-600 font-semibold" id="loading-message">Iniciando análise do lote...</p>
                </div>
            </div>
        </div>

        <div id="report-area" class="mt-8 hidden animate-fade-in">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold text-slate-800">Concluído!</span>
                    <span id="batch-progress" class="text-lg font-semibold text-green-600">100%</span>
                </div>
                <div class="h-2 bg-green-500 rounded-full w-full mb-6"></div>
                <div id="results-grid" class="result-grid">
                </div>
            </div>

            <div class="bg-blue-900 text-white p-4 flex justify-between items-center rounded-xl shadow-lg">
                <div class="text-lg font-bold">
                    TOTAL DA VISTORIA
                </div>
                <div class="flex items-center space-x-6">
                    <span id="grand-total-cbuq" class="text-xl font-extrabold text-yellow-400">
                        0.000 TON
                    </span>
                    <span id="grand-total-dano" class="text-lg font-semibold">
                        0.00 m² (acabamento)
                    </span>
                    <span class="text-lg font-semibold">
                        Total Detecções: <span id="grand-total-count" class="text-yellow-400">0</span>
                    </span>
                    <button id="print-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center shadow-lg">
                        <i class="fa-solid fa-print mr-2"></i> Imprimir Relatório
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        const fileInputCamera = document.getElementById('file-input-camera');
        const fileInputGallery = document.getElementById('file-input-gallery');
        const btnCamera = document.getElementById('btn-camera');
        const btnGallery = document.getElementById('btn-gallery');

        const uploadContent = document.getElementById('upload-content');
        const loading = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const reportArea = document.getElementById('report-area');
        const resultsGrid = document.getElementById('results-grid');

        // Rodapé de Totais
        const grandTotalCbuq = document.getElementById('grand-total-cbuq');
        const grandTotalDano = document.getElementById('grand-total-dano');
        const grandTotalCount = document.getElementById('grand-total-count');

        // Dispara os inputs
        btnCamera.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInputCamera.click();
        });

        btnGallery.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInputGallery.click();
        });

        // Event Listeners unificados
        fileInputCamera.addEventListener('change', (e) => {
            if (e.target.files.length > 0) processBatch(e.target.files);
        });

        fileInputGallery.addEventListener('change', (e) => {
            if (e.target.files.length > 0) processBatch(e.target.files);
        });

        /**
         * Envia todos os arquivos selecionados em um único lote (requisição multipart/form-data).
         */
        async function processBatch(files) {
            const fileArray = Array.from(files);

            // 1. Mostrar estado de carregamento e limpar resultados antigos
            uploadContent.classList.add('hidden');
            reportArea.classList.add('hidden');
            loading.classList.remove('hidden');
            resultsGrid.innerHTML = '';
            loadingMessage.textContent = `Preparando o envio de ${fileArray.length} fotos...`;

            const formData = new FormData();
            fileArray.forEach(file => {
                formData.append('files', file);
            });

            try {
                // 2. Envio do Lote para o novo endpoint de batch
                const apiUrl = '/detector/detectar'; // O endpoint agora aceita lista de arquivos

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();

                    // 3. Renderizar resultados e totais
                    renderBatchResults(result);
                } else {
                    const errorDetails = await response.json().catch(() => ({ message: 'Erro desconhecido.' }));
                    alert(`Erro na análise do lote. Código HTTP: ${response.status}. Detalhe: ${errorDetails.message}`);
                }
            } catch (error) {
                console.error('Erro de conexão ou processamento:', error);
                alert('Erro de conexão com o servidor ou de processamento fatal.');
            } finally {
                loading.classList.add('hidden');
            }
        }

        /**
         * Renderiza a grade de resultados e atualiza o rodapé de totais.
         */
        function renderBatchResults(data) {
            resultsGrid.innerHTML = '';

            data.batch_results.forEach((item, index) => {
                if (item.error) {
                    // Trata erros de arquivo individual
                    const errorCard = createErrorCard(item);
                    resultsGrid.insertAdjacentHTML('beforeend', errorCard);
                    return;
                }

                // Formatação dos valores para a exibição no card
                const areaM2 = parseFloat(item.total_dano_m2_file).toFixed(4);
                const massaT = parseFloat(item.total_cbuq_t_file).toFixed(3); // 3 casas decimais para Massa (t) no card
                const filename = item.file_name.length > 20 ? item.file_name.substring(0, 17) + '...' : item.file_name;
                const totalBuracos = item.count;

                const cardHTML = `
                    <div class="result-card">
                        <div class="p-2 bg-slate-200">
                            <span class="text-xs font-semibold text-slate-600">${filename}</span>
                        </div>
                        <div class="relative flex justify-center items-center h-48 bg-slate-300">
                            <img src="data:image/jpeg;base64,${item.image_b64}" alt="${item.file_name}" class="object-cover w-full h-full">
                            <div class="absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full font-bold">
                                ${totalBuracos} ${totalBuracos === 1 ? 'Buraco' : 'Buracos'}
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between font-bold text-sm mb-2">
                                <span class="text-slate-700">ID: #${index + 1}</span>
                                <span class="text-green-600">Confiança: 0.${totalBuracos > 0 ? item.report_data[0].cbuq_t.substring(item.report_data[0].cbuq_t.indexOf('.') + 1, item.report_data[0].cbuq_t.indexOf('.') + 3) : '00'}</span>
                            </div>
                            <div class="grid grid-cols-2 text-center border-t border-slate-200 pt-3">
                                <div>
                                    <p class="text-xs text-slate-500 uppercase">ACAB.(m²)</p>
                                    <p class="font-extrabold text-lg">${areaM2}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 uppercase">MASSA (t)</p>
                                    <p class="font-extrabold text-lg text-blue-700">${massaT}</p>
                                </div>
                            </div>
                            <button class="w-full mt-3 bg-blue-100 text-blue-700 text-xs py-1 rounded hover:bg-blue-200">
                                Clique para ampliar
                            </button>
                        </div>
                    </div>
                `;
                resultsGrid.insertAdjacentHTML('beforeend', cardHTML);
            });

            // 4. Atualizar totais gerais no rodapé
            grandTotalCbuq.textContent = `${data.grand_totals.total_cbuq_t} TON`;
            grandTotalDano.textContent = `${data.grand_totals.total_dano_m2} m² (acabamento)`;
            grandTotalCount.textContent = data.grand_totals.total_count;

            // 5. Mostrar área de resultados
            reportArea.classList.remove('hidden');
        }

        function createErrorCard(item) {
            return `
                <div class="result-card bg-red-100 border border-red-500">
                    <div class="p-4">
                        <p class="font-bold text-red-700">${item.file_name}</p>
                        <p class="text-sm text-red-600 mt-2">Erro: Não foi possível processar este arquivo.</p>
                        <p class="text-xs mt-1 text-red-500">Detalhe: ${item.error.substring(0, 50)}...</p>
                    </div>
                </div>
            `;
        }

        function reset() {
            reportArea.classList.add('hidden');
            uploadContent.classList.remove('hidden');
            fileInputCamera.value = '';
            fileInputGallery.value = '';
            resultsGrid.innerHTML = '';
            grandTotalCbuq.textContent = '0.000 TON';
            grandTotalDano.textContent = '0.00 m² (acabamento)';
            grandTotalCount.textContent = '0';
        }
    </script>
</body>

</html>